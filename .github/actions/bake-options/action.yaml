---
# yaml-language-server: $schema=https://json.schemastore.org/github-action.json
name: Bake Options
description: Takes an app and returns various fields from its docker-bake.hcl file

inputs:
  app:
    description: Application name
    required: true

outputs:
  platforms:
    description: Platforms
    value: ${{ steps.bake.outputs.platforms }}
  version:
    description: Version
    value: ${{ steps.bake.outputs.version }}
  image-name:
    description: Image Name
    value: ${{ steps.bake.outputs.image-name }}

runs:
  using: composite
  steps:
    - name: Bake Options
      id: bake
      shell: bash
      run: |
        BAKE_OPTS=$(docker buildx bake --file ./apps/${{ inputs.app }}/docker-bake.hcl image-all --print 2>/dev/null)

        PLATFORMS=$(jq --raw-output --compact-output '.target."image-all".platforms' <<< "$BAKE_OPTS")
        echo "platforms=${PLATFORMS}" >> $GITHUB_OUTPUT

        VERSION=$(jq --raw-output --compact-output '.target."image-all".args.VERSION' <<< "$BAKE_OPTS")
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

        IMAGE_NAME=$(jq --raw-output '.target."image-all".args.IMAGE_NAME // "${{ inputs.app }}"' <<< "$BAKE_OPTS")
        if [ "$IMAGE_NAME" = "null" ] || [ -z "$IMAGE_NAME" ]; then
          IMAGE_NAME="${{ inputs.app }}"
        fi
        echo "image-name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
